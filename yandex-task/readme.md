Тестовое задание для компании "Яндекс"
=======================================

Файлы в проекте:
- yandex.task1.zip - первоначальная версия на C++ (22.01.2011)  
- yandex.task1.ver2.zip - вторая версия на C++.  
- yandex.task1.ver2.utf8/ - вторая версия на C++. Исходники в кодировке UTF-8.  

## Формулировка задачи. 
(Цитата компании "Яндекс")  
Необходимо написать консольную программу на C++ под Windows, которую можно будет запустить в нескольких экземплярах. В одном из запущенных экземпляров должен создаться дополнительный поток, называемый "диспетчером". Диспетчер содержит счетчик (int), инициализированный нулем. Раз в секунду диспетчер увеличивает счетчик на единицу и каким-то образом передает строковое значение счетчика всем экземплярам программы (в том числе и тому, в котором он сам запущен). Экземпляры программы получив значение счетчика выводят его на экран.  
При закрытии экземпляра программы в котором работает диспетчер, диспетчер должен создаться в другом запущенном экземпляре и продолжить увеличивать счетчик и сообщать об этом оставшимся экземплярам программы.  
Программа должна компилироваться одним из компиляторов C++ на выбор: Visual Studio 6.0, Visual Studio 2005, Visual Studio 2008 или бесплатным компилятором из Microsoft Platform SDK  
Программа должна работать на одной (работа сразу на всех будет плюсом) из версий 32-х разрядной Windows на выбор: Windows XP, Windows Vista, Windows 7  
Можно использовать: WinAPI, MFC, ATL, STL  
Нельзя использовать: Qt, boost, COM (в этой задаче он не нужен), loki и другие библиотеки  


## Описание реализации на C++

В моём решении для передачи значения счётчика используется FileMapping, 
все процессы читают(и записывают) это значение последовательно.  
Кроме того, реализация не гарантирует, что все процессы прочитают все значения счетчика.  
Одновременно может быть запущено неограниченное кол-во экземпляров программы. Экземпляры программы могут запускаться и завершаться в любой момент.  
Используется только WinAPI.  
Основные числовые и символьные константы находятся в файле constant.h  
Класс helper содержит вспомогательные функции.  


### Алгоритм работы.

Функция main создает поток диспетчера (Dispatcher), затем запускает цикл чтения значения счетчика(Receiver).  
Receiver находится в состоянии ожидания(с тайм-аутом) события CounterWriteEvent.  
Поток диспетчера создает DispatcherMutex и, если другой диспетчер не захватил мютекс, создает FileMapping, через который передает значение счетчика. В случае, если мютекс уже создан, диспетчер переходит в состояние ожидания. Как только мютекс освободится(предыдущий диспетчер завершился) диспетчер читает значение счетчика из FileMapping и запускает цикл записи новых значений счетчика.  
После записи очередного значения диспетчер устанавливает событие (CounterWriteEvent) и Receiver выводит значение счетчика на экран.


### Изменения.

Версия 2  
Для интервала времени (1 сек.) используется waitable timer (вместо sleep в первой версии). Это позволяет исключить влияние на этот интервал времени чтения/записи счетчика. Таким образом, интервал не зависит от кол-ва экземпляров программы и их быстродействия.


================================================================================
# Реализация на java
см.  
[https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/nio/channels/DatagramChannel.html](https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/nio/channels/DatagramChannel.html)  
[https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/nio/channels/MulticastChannel.html](https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/nio/channels/MulticastChannel.html)  
[https://docs.oracle.com/en/java/javase/17/core/internet-protocol-and-unix-domain-sockets-nio-example.html](https://docs.oracle.com/en/java/javase/17/core/internet-protocol-and-unix-domain-sockets-nio-example.html)  
[https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/nio/channels/FileChannel.html#lock()](https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/nio/channels/FileChannel.html#lock())  
[https://docs.oracle.com/javase/tutorial/essential/concurrency/](https://docs.oracle.com/javase/tutorial/essential/concurrency/)  
[https://firewalld.org](https://firewalld.org)  

### Описание реализации
В реализации на java для передачи значения счётчика используются дейтаграмные сокеты в режиме многоадресной передачи. Запуск диспетчеров 
синхронизируется с помощью блокировки файла.
Одновременно может быть запущено неограниченное количество экземпляров программы. Экземпляры программы могут запускаться и завершаться в любой момент.  

### Алгоритм работы
При запуске программы создаётся экземляр счётчика (класс Counter), который хранит значение счётчика, поток диспетчера (класс Dispatcher) и поток приёмника (класс Receiver). Диспетчер и приёмник получают экземпляр счётчика. Диспетчер в начале работы пытается сделать эксклюзивную блокировку файла, и, если ему это удаётся, запускает цикл рассылки значения счётчика. Остальные запущенные диспетчеры (в других экземплярах программы) ждут освобождения файла. Поток приёмника ожидает получения очередного значения счётчика, и, пополучении, выводит значение на консоль и сохраняет в классе Counter. В случае завершения диспетчера, захватившего блокировку файла, файл блокирует 
один из диспетчеров в других экземплярах программы, получает последнее принятое приёмником значение счётчика и запускает свой цикл рассылки значения счётчика.

### Запуск программы
Настроить имя сетевого интерфейса в файле Constant.java

```
NetworkInterfaceName = "enp0s25";
```
Открыть порт, необходимый для работы программы

```
sudo firewall-cmd --direct --add-rule ipv4 filter OUTPUT 0 -d 239.8.7.6 -p udp --dport 6789 -j ACCEPT
sudo firewall-cmd --add-port=6789/udp
```
Запутить программу

```
clear && java -classpath /home/dm/git/examples/yandex-task/target/classes yandexTask.Main
```



##### Преобразование файлов в кодировке WINDOWS-1251 в UTF-8 с использованием iconv
```
cd /home/dm/eclipse-workspace/yandex-task/yandex.task1.ver2/
for FILE in {*.h,*.cpp,*.txt}; do echo $FILE; iconv -f CP1251 -t UTF8 -o /home/dm/eclipse-workspace/yandex-task/yandex.task1.ver2.utf8/$FILE $FILE; done;
```